using Google.Protobuf;
using SqlcGenCsharp.Drivers;
using System;
using System.Linq;
using File = Plugin.File;


namespace SqlcGenCsharp.Generators;

internal class CsprojGen(DbDriver dbDriver, string outputDirectory, string projectName, string namespaceName)
{
    public File GenerateFile()
    {
        var csprojContents = GetFileContents();
        return new File
        {
            Name = $"{projectName}.csproj",
            Contents = ByteString.CopyFromUtf8(csprojContents)
        };
    }

    private string GetFileContents()
    {
        var optionalNullableProperty = dbDriver.Options.DotnetFramework.IsDotnetCore() ? Environment.NewLine + "        <Nullable>enable</Nullable>" : "";
        var referenceItems = dbDriver.GetPackageReferences()
            .Select(p => dbDriver.Options.UseCentralPackageManagement 
                    ? $"""        <PackageReference Include="{p.Key}" />"""
                    : $"""        <PackageReference Include="{p.Key}" Version="{p.Value}"/>""")
            .JoinByNewLine();

        return $"""
                <!--{Consts.AutoGeneratedComment}-->
                <!--Run the following to add the project to the solution:
                   dotnet sln add {outputDirectory}/{projectName}.csproj
                  -->
                <Project Sdk="Microsoft.NET.Sdk">
                
                    <PropertyGroup>
                        <TargetFramework>{dbDriver.Options.DotnetFramework.ToName()}</TargetFramework>
                        <RootNamespace>{namespaceName}</RootNamespace>
                        <OutputType>Library</OutputType>{optionalNullableProperty}
                        <ManagePackageVersionsCentrally>{dbDriver.Options.UseCentralPackageManagement}</ManagePackageVersionsCentrally>
                    </PropertyGroup>
                
                    <ItemGroup>
                {referenceItems}
                    </ItemGroup>

                </Project>
                """;
    }
}