using Microsoft.CodeAnalysis.CSharp.Syntax;
using SqlcGenCsharp.Drivers;
using static Microsoft.CodeAnalysis.CSharp.SyntaxFactory;
using System;
using Google.Protobuf;
using Microsoft.CodeAnalysis;
using File = Plugin.File;


namespace SqlcGenCsharp.Generators;

internal class CsprojGen(string projectName, string sqlEngine)
{
    public File GenerateFile()
    {
        var csprojContents = GetFileContents();
        return new File
        {
            Name = $"{projectName}.csproj",
            Contents = ByteString.CopyFromUtf8(csprojContents)
        };
    }
    
    private string GetFileContents()
    {
        // TODO move to RESOURCES file
        var csprojTemplate = """
                             <!--auto-generated by sqlc at #CurrentDate# - do not edit-->
                             <Project Sdk="Microsoft.NET.Sdk">
                             
                                 <PropertyGroup>
                                     <TargetFramework>net8.0</TargetFramework>
                                     <Nullable>enable</Nullable>
                                     <OutputType>Library</OutputType>
                                 </PropertyGroup>
                             
                                 <ItemGroup>
                                     <PackageReference Include="#PackageName#" Version="#PackageVersion#"/>
                                 </ItemGroup>
                             
                             </Project>
                             """;
        
        // TODO should be string interpolation - in multiline?
        var (packageName, packageVersion) = GetPackageNameAndVersion();
        return csprojTemplate
            .Replace("#PackageName#", packageName)
            .Replace("#PackageVersion#", packageVersion)
            .Replace("#CurrentDate#", $"{DateTime.Now:g}");
    }

    private (string, string) GetPackageNameAndVersion()
    {
        return sqlEngine switch
        {
            "postgresql" => ("Npgsql", "8.0.2"),
            "mysql" => ("MySqlConnector", "2.3.6"),
            _ => throw new NotSupportedException($"Unsupported SQL engine: {sqlEngine}")
        };
    }
}