using Microsoft.CodeAnalysis.CSharp.Syntax;
using Plugin;
using SqlcGenCsharp.Drivers;
using System.Collections.Generic;
using System.Linq;
using static Microsoft.CodeAnalysis.CSharp.SyntaxFactory;


namespace SqlcGenCsharp.Generators;

internal class ModelsGen(DbDriver dbDriver, string namespaceName)
{
    private const string ClassName = "Models";

    private RootGen RootGen { get; } = new(dbDriver.Options);

    private DataClassesGen DataClassesGen { get; } = new(dbDriver);


    private EnumsGen EnumsGen { get; } = new(dbDriver);

    public File GenerateFile(Dictionary<string, Table> tables, Dictionary<string, Enum> enums)
    {
        var dataclassModels = GenerateModelsDataClasses(tables);
        var enumModels = GenerateModelsEnums(enums);
        dataclassModels = dataclassModels.Concat(enumModels).ToArray();

        var usingDirectives = dbDriver.GetUsingDirectivesForModels();
        var root = RootGen.CompilationRootGen(IdentifierName(namespaceName), usingDirectives, dataclassModels);
        root = root.AddCommentOnTop(Consts.AutoGeneratedComment);

        return new File
        {
            Name = $"{ClassName}.cs",
            Contents = root.ToByteString()
        };
    }

    private MemberDeclarationSyntax[] GenerateModelsDataClasses(Dictionary<string, Table> tables)
    {
        return (
            from table in tables.Values
            let className = $"{table.Rel.Schema}_{table.Rel.Name}"
            select DataClassesGen.Generate(className.ToModelName(), ClassMember.Model, table.Columns, dbDriver.Options)
        ).ToArray();
    }

    private MemberDeclarationSyntax[] GenerateModelsEnums(Dictionary<string, Enum> enums)
    {
        return enums.Values.SelectMany(e => EnumsGen.Generate(e.Name, e.Vals)).ToArray();
    }
}