// auto-generated by sqlc - do not edit
// ReSharper disable UseObjectOrCollectionInitializer
// ReSharper disable UseAwaitUsing
// ReSharper disable ConvertToUsingDeclaration
// ReSharper disable NotAccessedPositionalProperty.Global
// ReSharper disable UnusedAutoPropertyAccessor.Global
using Microsoft.Data.Sqlite;
using System;
using System.Collections.Generic;
using System.Data;
using System.Threading;
using System.Threading.Tasks;

namespace SqliteSqlcImpl;
public class QuerySql
{
    public QuerySql()
    {
    }

    public QuerySql(string connectionString) : this()
    {
        this.ConnectionString = connectionString;
    }

    private QuerySql(SqliteTransaction transaction) : this()
    {
        this.Transaction = transaction;
    }

    public static QuerySql WithTransaction(SqliteTransaction transaction)
    {
        return new QuerySql(transaction);
    }

    private SqliteTransaction? Transaction { get; }
    private string? ConnectionString { get; }

    private const string GetCustomerOrdersSql = @"SELECT 
                                                      o.order_id, ordered_at, order_state, total_amount, order_item_id, i.quantity, i.unit_price, 
                                                      p.product_id, p.name as product_name, p.category as product_category
                                                  FROM orders o
                                                  JOIN order_items i
                                                  USING (order_id)
                                                  JOIN products p
                                                  USING (product_id)
                                                  WHERE o.customer_id = @customer_id
                                                  ORDER BY o.ordered_at DESC
                                                  LIMIT @limit OFFSET @offset";
    public readonly record struct GetCustomerOrdersRow(string OrderId, string OrderedAt, string OrderState, decimal TotalAmount, string OrderItemId, int Quantity, decimal UnitPrice, int ProductId, string ProductName, string ProductCategory);
    public readonly record struct GetCustomerOrdersArgs(int CustomerId, int Offset, int Limit);
    public async Task<List<GetCustomerOrdersRow>> GetCustomerOrdersAsync(GetCustomerOrdersArgs args)
    {
        if (this.Transaction == null)
        {
            using (var connection = new SqliteConnection(ConnectionString))
            {
                await connection.OpenAsync();
                using (var command = new SqliteCommand(GetCustomerOrdersSql, connection))
                {
                    command.Parameters.AddWithValue("@customer_id", args.CustomerId);
                    command.Parameters.AddWithValue("@offset", args.Offset);
                    command.Parameters.AddWithValue("@limit", args.Limit);
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        var result = new List<GetCustomerOrdersRow>();
                        while (await reader.ReadAsync())
                            result.Add(new GetCustomerOrdersRow { OrderId = reader.GetString(0), OrderedAt = reader.GetString(1), OrderState = reader.GetString(2), TotalAmount = reader.GetDecimal(3), OrderItemId = reader.GetString(4), Quantity = reader.GetInt32(5), UnitPrice = reader.GetDecimal(6), ProductId = reader.GetInt32(7), ProductName = reader.GetString(8), ProductCategory = reader.GetString(9) });
                        return result;
                    }
                }
            }
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetCustomerOrdersSql;
            command.Transaction = this.Transaction;
            command.Parameters.AddWithValue("@customer_id", args.CustomerId);
            command.Parameters.AddWithValue("@offset", args.Offset);
            command.Parameters.AddWithValue("@limit", args.Limit);
            using (var reader = await command.ExecuteReaderAsync())
            {
                var result = new List<GetCustomerOrdersRow>();
                while (await reader.ReadAsync())
                    result.Add(new GetCustomerOrdersRow { OrderId = reader.GetString(0), OrderedAt = reader.GetString(1), OrderState = reader.GetString(2), TotalAmount = reader.GetDecimal(3), OrderItemId = reader.GetString(4), Quantity = reader.GetInt32(5), UnitPrice = reader.GetDecimal(6), ProductId = reader.GetInt32(7), ProductName = reader.GetString(8), ProductCategory = reader.GetString(9) });
                return result;
            }
        }
    }

    private const string AddProductsSql = "INSERT INTO products (name, category, unit_price, stock_quantity, description) VALUES (@name, @category, @unit_price, @stock_quantity, @description)";
    public readonly record struct AddProductsArgs(string Name, string Category, decimal UnitPrice, int StockQuantity, string? Description);
    public async Task AddProductsAsync(List<AddProductsArgs> args)
    {
        using (var connection = new SqliteConnection(ConnectionString))
        {
            await connection.OpenAsync();
            var transformedSql = Utils.TransformQueryForSqliteBatch(AddProductsSql, args.Count);
            using (var command = new SqliteCommand(transformedSql, connection))
            {
                for (int i = 0; i < args.Count; i++)
                {
                    command.Parameters.AddWithValue($"@name{i}", args[i].Name);
                    command.Parameters.AddWithValue($"@category{i}", args[i].Category);
                    command.Parameters.AddWithValue($"@unit_price{i}", args[i].UnitPrice);
                    command.Parameters.AddWithValue($"@stock_quantity{i}", args[i].StockQuantity);
                    command.Parameters.AddWithValue($"@description{i}", args[i].Description ?? (object)DBNull.Value);
                }

                await command.ExecuteScalarAsync();
            }
        }
    }

    private const string AddOrdersSql = "INSERT INTO orders (order_id, customer_id, order_state, total_amount) VALUES (@order_id, @customer_id, @order_state, @total_amount)";
    public readonly record struct AddOrdersArgs(string OrderId, int CustomerId, string OrderState, decimal TotalAmount);
    public async Task AddOrdersAsync(List<AddOrdersArgs> args)
    {
        using (var connection = new SqliteConnection(ConnectionString))
        {
            await connection.OpenAsync();
            var transformedSql = Utils.TransformQueryForSqliteBatch(AddOrdersSql, args.Count);
            using (var command = new SqliteCommand(transformedSql, connection))
            {
                for (int i = 0; i < args.Count; i++)
                {
                    command.Parameters.AddWithValue($"@order_id{i}", args[i].OrderId);
                    command.Parameters.AddWithValue($"@customer_id{i}", args[i].CustomerId);
                    command.Parameters.AddWithValue($"@order_state{i}", args[i].OrderState);
                    command.Parameters.AddWithValue($"@total_amount{i}", args[i].TotalAmount);
                }

                await command.ExecuteScalarAsync();
            }
        }
    }

    private const string AddOrderItemsSql = "INSERT INTO order_items (order_item_id, order_id, product_id, quantity, unit_price) VALUES (@order_item_id, @order_id, @product_id, @quantity, @unit_price)";
    public readonly record struct AddOrderItemsArgs(string OrderItemId, string OrderId, int ProductId, int Quantity, decimal UnitPrice);
    public async Task AddOrderItemsAsync(List<AddOrderItemsArgs> args)
    {
        using (var connection = new SqliteConnection(ConnectionString))
        {
            await connection.OpenAsync();
            var transformedSql = Utils.TransformQueryForSqliteBatch(AddOrderItemsSql, args.Count);
            using (var command = new SqliteCommand(transformedSql, connection))
            {
                for (int i = 0; i < args.Count; i++)
                {
                    command.Parameters.AddWithValue($"@order_item_id{i}", args[i].OrderItemId);
                    command.Parameters.AddWithValue($"@order_id{i}", args[i].OrderId);
                    command.Parameters.AddWithValue($"@product_id{i}", args[i].ProductId);
                    command.Parameters.AddWithValue($"@quantity{i}", args[i].Quantity);
                    command.Parameters.AddWithValue($"@unit_price{i}", args[i].UnitPrice);
                }

                await command.ExecuteScalarAsync();
            }
        }
    }
}