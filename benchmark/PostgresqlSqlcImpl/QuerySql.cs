// auto-generated by sqlc - do not edit
// ReSharper disable UseObjectOrCollectionInitializer
// ReSharper disable UseAwaitUsing
// ReSharper disable ConvertToUsingDeclaration
// ReSharper disable NotAccessedPositionalProperty.Global
// ReSharper disable UnusedAutoPropertyAccessor.Global
using Npgsql;
using NpgsqlTypes;
using System;
using System.Collections.Generic;
using System.Data;
using System.Threading;
using System.Threading.Tasks;

namespace PostgresSqlcImpl;
public class QuerySql : IDisposable
{
    public QuerySql()
    {
    }

    public QuerySql(string connectionString) : this()
    {
        this.ConnectionString = connectionString;
        _dataSource = new Lazy<NpgsqlDataSource>(() => NpgsqlDataSource.Create(connectionString!), LazyThreadSafetyMode.ExecutionAndPublication);
    }

    private QuerySql(NpgsqlTransaction transaction) : this()
    {
        this.Transaction = transaction;
    }

    public static QuerySql WithTransaction(NpgsqlTransaction transaction)
    {
        return new QuerySql(transaction);
    }

    private NpgsqlTransaction? Transaction { get; }
    private string? ConnectionString { get; }

    private readonly Lazy<NpgsqlDataSource>? _dataSource;
    private NpgsqlDataSource GetDataSource()
    {
        if (_dataSource == null)
            throw new InvalidOperationException("ConnectionString is required when not using a transaction");
        return _dataSource.Value;
    }

    public void Dispose()
    {
        GC.SuppressFinalize(this);
        if (_dataSource?.IsValueCreated == true)
            _dataSource.Value.Dispose();
    }

    private const string GetCustomerOrdersSql = @"SELECT 
                                                      o.order_id, ordered_at, order_state, total_amount, order_item_id, i.quantity, i.unit_price, 
                                                      p.product_id, p.name as product_name, p.category as product_category
                                                  FROM sales.orders o
                                                  JOIN sales.order_items i
                                                  USING (order_id)
                                                  JOIN sales.products p
                                                  USING (product_id)
                                                  WHERE o.customer_id = @customer_id
                                                  ORDER BY o.ordered_at DESC
                                                  LIMIT @limit OFFSET @offset";
    public readonly record struct GetCustomerOrdersRow(int OrderId, DateTime OrderedAt, string OrderState, decimal TotalAmount, int OrderItemId, int Quantity, decimal UnitPrice, int ProductId, string ProductName, string ProductCategory);
    public readonly record struct GetCustomerOrdersArgs(int CustomerId, int Offset, int Limit);
    public async Task<List<GetCustomerOrdersRow>> GetCustomerOrdersAsync(GetCustomerOrdersArgs args)
    {
        if (this.Transaction == null)
        {
            using (var connection = await GetDataSource().OpenConnectionAsync())
            {
                using (var command = connection.CreateCommand())
                {
                    command.CommandText = GetCustomerOrdersSql;
                    command.Parameters.AddWithValue("@customer_id", args.CustomerId);
                    command.Parameters.AddWithValue("@offset", args.Offset);
                    command.Parameters.AddWithValue("@limit", args.Limit);
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        var result = new List<GetCustomerOrdersRow>();
                        while (await reader.ReadAsync())
                            result.Add(new GetCustomerOrdersRow { OrderId = reader.GetInt32(0), OrderedAt = reader.GetDateTime(1), OrderState = reader.GetString(2), TotalAmount = reader.GetDecimal(3), OrderItemId = reader.GetInt32(4), Quantity = reader.GetInt32(5), UnitPrice = reader.GetDecimal(6), ProductId = reader.GetInt32(7), ProductName = reader.GetString(8), ProductCategory = reader.GetString(9) });
                        return result;
                    }
                }
            }
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetCustomerOrdersSql;
            command.Transaction = this.Transaction;
            command.Parameters.AddWithValue("@customer_id", args.CustomerId);
            command.Parameters.AddWithValue("@offset", args.Offset);
            command.Parameters.AddWithValue("@limit", args.Limit);
            using (var reader = await command.ExecuteReaderAsync())
            {
                var result = new List<GetCustomerOrdersRow>();
                while (await reader.ReadAsync())
                    result.Add(new GetCustomerOrdersRow { OrderId = reader.GetInt32(0), OrderedAt = reader.GetDateTime(1), OrderState = reader.GetString(2), TotalAmount = reader.GetDecimal(3), OrderItemId = reader.GetInt32(4), Quantity = reader.GetInt32(5), UnitPrice = reader.GetDecimal(6), ProductId = reader.GetInt32(7), ProductName = reader.GetString(8), ProductCategory = reader.GetString(9) });
                return result;
            }
        }
    }

    private const string AddCustomersSql = "COPY sales.customers (name, email, phone, address, registered_at) FROM STDIN (FORMAT BINARY)";
    public readonly record struct AddCustomersArgs(string Name, string Email, string Phone, string? Address, DateTime RegisteredAt);
    public async Task AddCustomersAsync(List<AddCustomersArgs> args)
    {
        using (var connection = await GetDataSource().OpenConnectionAsync())
        {
            using (var writer = await connection.BeginBinaryImportAsync(AddCustomersSql))
            {
                foreach (var row in args)
                {
                    await writer.StartRowAsync();
                    await writer.WriteAsync(row.Name);
                    await writer.WriteAsync(row.Email);
                    await writer.WriteAsync(row.Phone);
                    await writer.WriteAsync(row.Address ?? (object)DBNull.Value);
                    await writer.WriteAsync(row.RegisteredAt, NpgsqlDbType.Timestamp);
                }

                await writer.CompleteAsync();
            }
        }
    }

    private const string AddProductsSql = "COPY sales.products (name, category, unit_price, stock_quantity, description) FROM STDIN (FORMAT BINARY)";
    public readonly record struct AddProductsArgs(string Name, string Category, decimal UnitPrice, int StockQuantity, string? Description);
    public async Task AddProductsAsync(List<AddProductsArgs> args)
    {
        using (var connection = await GetDataSource().OpenConnectionAsync())
        {
            using (var writer = await connection.BeginBinaryImportAsync(AddProductsSql))
            {
                foreach (var row in args)
                {
                    await writer.StartRowAsync();
                    await writer.WriteAsync(row.Name);
                    await writer.WriteAsync(row.Category);
                    await writer.WriteAsync(row.UnitPrice);
                    await writer.WriteAsync(row.StockQuantity);
                    await writer.WriteAsync(row.Description ?? (object)DBNull.Value);
                }

                await writer.CompleteAsync();
            }
        }
    }

    private const string AddOrdersSql = "COPY sales.orders (customer_id, order_state, total_amount) FROM STDIN (FORMAT BINARY)";
    public readonly record struct AddOrdersArgs(int CustomerId, string OrderState, decimal TotalAmount);
    public async Task AddOrdersAsync(List<AddOrdersArgs> args)
    {
        using (var connection = await GetDataSource().OpenConnectionAsync())
        {
            using (var writer = await connection.BeginBinaryImportAsync(AddOrdersSql))
            {
                foreach (var row in args)
                {
                    await writer.StartRowAsync();
                    await writer.WriteAsync(row.CustomerId);
                    await writer.WriteAsync(row.OrderState);
                    await writer.WriteAsync(row.TotalAmount);
                }

                await writer.CompleteAsync();
            }
        }
    }

    private const string AddOrderItemsSql = "COPY sales.order_items (order_id, product_id, quantity, unit_price) FROM STDIN (FORMAT BINARY)";
    public readonly record struct AddOrderItemsArgs(int OrderId, int ProductId, int Quantity, decimal UnitPrice);
    public async Task AddOrderItemsAsync(List<AddOrderItemsArgs> args)
    {
        using (var connection = await GetDataSource().OpenConnectionAsync())
        {
            using (var writer = await connection.BeginBinaryImportAsync(AddOrderItemsSql))
            {
                foreach (var row in args)
                {
                    await writer.StartRowAsync();
                    await writer.WriteAsync(row.OrderId);
                    await writer.WriteAsync(row.ProductId);
                    await writer.WriteAsync(row.Quantity);
                    await writer.WriteAsync(row.UnitPrice);
                }

                await writer.CompleteAsync();
            }
        }
    }

    private const string GetCustomerIdsSql = "SELECT customer_id FROM sales.customers ORDER BY customer_id LIMIT @limit";
    public readonly record struct GetCustomerIdsRow(int CustomerId);
    public readonly record struct GetCustomerIdsArgs(int Limit);
    public async Task<List<GetCustomerIdsRow>> GetCustomerIdsAsync(GetCustomerIdsArgs args)
    {
        if (this.Transaction == null)
        {
            using (var connection = await GetDataSource().OpenConnectionAsync())
            {
                using (var command = connection.CreateCommand())
                {
                    command.CommandText = GetCustomerIdsSql;
                    command.Parameters.AddWithValue("@limit", args.Limit);
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        var result = new List<GetCustomerIdsRow>();
                        while (await reader.ReadAsync())
                            result.Add(new GetCustomerIdsRow { CustomerId = reader.GetInt32(0) });
                        return result;
                    }
                }
            }
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetCustomerIdsSql;
            command.Transaction = this.Transaction;
            command.Parameters.AddWithValue("@limit", args.Limit);
            using (var reader = await command.ExecuteReaderAsync())
            {
                var result = new List<GetCustomerIdsRow>();
                while (await reader.ReadAsync())
                    result.Add(new GetCustomerIdsRow { CustomerId = reader.GetInt32(0) });
                return result;
            }
        }
    }

    private const string GetProductIdsSql = "SELECT product_id FROM sales.products ORDER BY product_id LIMIT @limit";
    public readonly record struct GetProductIdsRow(int ProductId);
    public readonly record struct GetProductIdsArgs(int Limit);
    public async Task<List<GetProductIdsRow>> GetProductIdsAsync(GetProductIdsArgs args)
    {
        if (this.Transaction == null)
        {
            using (var connection = await GetDataSource().OpenConnectionAsync())
            {
                using (var command = connection.CreateCommand())
                {
                    command.CommandText = GetProductIdsSql;
                    command.Parameters.AddWithValue("@limit", args.Limit);
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        var result = new List<GetProductIdsRow>();
                        while (await reader.ReadAsync())
                            result.Add(new GetProductIdsRow { ProductId = reader.GetInt32(0) });
                        return result;
                    }
                }
            }
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetProductIdsSql;
            command.Transaction = this.Transaction;
            command.Parameters.AddWithValue("@limit", args.Limit);
            using (var reader = await command.ExecuteReaderAsync())
            {
                var result = new List<GetProductIdsRow>();
                while (await reader.ReadAsync())
                    result.Add(new GetProductIdsRow { ProductId = reader.GetInt32(0) });
                return result;
            }
        }
    }

    private const string GetOrderItemsCountSql = "SELECT COUNT(*) AS cnt FROM sales.order_items";
    public readonly record struct GetOrderItemsCountRow(long Cnt);
    public async Task<GetOrderItemsCountRow?> GetOrderItemsCountAsync()
    {
        if (this.Transaction == null)
        {
            using (var connection = await GetDataSource().OpenConnectionAsync())
            {
                using (var command = connection.CreateCommand())
                {
                    command.CommandText = GetOrderItemsCountSql;
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        if (await reader.ReadAsync())
                        {
                            return new GetOrderItemsCountRow
                            {
                                Cnt = reader.GetInt64(0)
                            };
                        }
                    }
                }
            };
            return null;
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetOrderItemsCountSql;
            command.Transaction = this.Transaction;
            using (var reader = await command.ExecuteReaderAsync())
            {
                if (await reader.ReadAsync())
                {
                    return new GetOrderItemsCountRow
                    {
                        Cnt = reader.GetInt64(0)
                    };
                }
            }
        }

        return null;
    }

    private const string GetOrderIdsSql = "SELECT order_id FROM sales.orders ORDER BY ordered_at DESC LIMIT @limit";
    public readonly record struct GetOrderIdsRow(int OrderId);
    public readonly record struct GetOrderIdsArgs(int Limit);
    public async Task<List<GetOrderIdsRow>> GetOrderIdsAsync(GetOrderIdsArgs args)
    {
        if (this.Transaction == null)
        {
            using (var connection = await GetDataSource().OpenConnectionAsync())
            {
                using (var command = connection.CreateCommand())
                {
                    command.CommandText = GetOrderIdsSql;
                    command.Parameters.AddWithValue("@limit", args.Limit);
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        var result = new List<GetOrderIdsRow>();
                        while (await reader.ReadAsync())
                            result.Add(new GetOrderIdsRow { OrderId = reader.GetInt32(0) });
                        return result;
                    }
                }
            }
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetOrderIdsSql;
            command.Transaction = this.Transaction;
            command.Parameters.AddWithValue("@limit", args.Limit);
            using (var reader = await command.ExecuteReaderAsync())
            {
                var result = new List<GetOrderIdsRow>();
                while (await reader.ReadAsync())
                    result.Add(new GetOrderIdsRow { OrderId = reader.GetInt32(0) });
                return result;
            }
        }
    }

    private const string GetOrderAmountsSql = "SELECT order_id, total_amount FROM sales.orders WHERE order_id = ANY(@order_ids)";
    public readonly record struct GetOrderAmountsRow(int OrderId, decimal TotalAmount);
    public readonly record struct GetOrderAmountsArgs(int OrderIds);
    public async Task<List<GetOrderAmountsRow>> GetOrderAmountsAsync(GetOrderAmountsArgs args)
    {
        if (this.Transaction == null)
        {
            using (var connection = await GetDataSource().OpenConnectionAsync())
            {
                using (var command = connection.CreateCommand())
                {
                    command.CommandText = GetOrderAmountsSql;
                    command.Parameters.AddWithValue("@order_ids", args.OrderIds);
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        var result = new List<GetOrderAmountsRow>();
                        while (await reader.ReadAsync())
                            result.Add(new GetOrderAmountsRow { OrderId = reader.GetInt32(0), TotalAmount = reader.GetDecimal(1) });
                        return result;
                    }
                }
            }
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetOrderAmountsSql;
            command.Transaction = this.Transaction;
            command.Parameters.AddWithValue("@order_ids", args.OrderIds);
            using (var reader = await command.ExecuteReaderAsync())
            {
                var result = new List<GetOrderAmountsRow>();
                while (await reader.ReadAsync())
                    result.Add(new GetOrderAmountsRow { OrderId = reader.GetInt32(0), TotalAmount = reader.GetDecimal(1) });
                return result;
            }
        }
    }

    private const string GetProductPricesSql = "SELECT product_id, unit_price FROM sales.products WHERE product_id = ANY(@product_ids)";
    public readonly record struct GetProductPricesRow(int ProductId, decimal UnitPrice);
    public readonly record struct GetProductPricesArgs(int ProductIds);
    public async Task<List<GetProductPricesRow>> GetProductPricesAsync(GetProductPricesArgs args)
    {
        if (this.Transaction == null)
        {
            using (var connection = await GetDataSource().OpenConnectionAsync())
            {
                using (var command = connection.CreateCommand())
                {
                    command.CommandText = GetProductPricesSql;
                    command.Parameters.AddWithValue("@product_ids", args.ProductIds);
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        var result = new List<GetProductPricesRow>();
                        while (await reader.ReadAsync())
                            result.Add(new GetProductPricesRow { ProductId = reader.GetInt32(0), UnitPrice = reader.GetDecimal(1) });
                        return result;
                    }
                }
            }
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetProductPricesSql;
            command.Transaction = this.Transaction;
            command.Parameters.AddWithValue("@product_ids", args.ProductIds);
            using (var reader = await command.ExecuteReaderAsync())
            {
                var result = new List<GetProductPricesRow>();
                while (await reader.ReadAsync())
                    result.Add(new GetProductPricesRow { ProductId = reader.GetInt32(0), UnitPrice = reader.GetDecimal(1) });
                return result;
            }
        }
    }
}