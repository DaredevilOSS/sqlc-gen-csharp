// auto-generated by sqlc - do not edit
// ReSharper disable UseObjectOrCollectionInitializer
// ReSharper disable UseAwaitUsing
// ReSharper disable ConvertToUsingDeclaration
// ReSharper disable NotAccessedPositionalProperty.Global
// ReSharper disable UnusedAutoPropertyAccessor.Global
using Npgsql;
using System;
using System.Collections.Generic;
using System.Data;
using System.Threading;
using System.Threading.Tasks;

namespace PostgresSqlcImpl;
public class QuerySql : IDisposable
{
    public QuerySql()
    {
    }

    public QuerySql(string connectionString) : this()
    {
        this.ConnectionString = connectionString;
        _dataSource = new Lazy<NpgsqlDataSource>(() => NpgsqlDataSource.Create(connectionString!), LazyThreadSafetyMode.ExecutionAndPublication);
    }

    private QuerySql(NpgsqlTransaction transaction) : this()
    {
        this.Transaction = transaction;
    }

    public static QuerySql WithTransaction(NpgsqlTransaction transaction)
    {
        return new QuerySql(transaction);
    }

    private NpgsqlTransaction? Transaction { get; }
    private string? ConnectionString { get; }

    public void Dispose()
    {
        GC.SuppressFinalize(this);
        if (_dataSource?.IsValueCreated == true)
            _dataSource.Value.Dispose();
    }

    private readonly Lazy<NpgsqlDataSource>? _dataSource;
    private NpgsqlDataSource GetDataSource()
    {
        if (_dataSource == null)
            throw new InvalidOperationException("ConnectionString is required when not using a transaction");
        return _dataSource.Value;
    }

    private const string GetCustomerOrdersSql = @"SELECT 
                                                      o.order_id, ordered_at, order_state, total_amount, order_item_id, i.quantity, i.unit_price, 
                                                      p.product_id, p.name as product_name, p.category as product_category
                                                  FROM sales.orders o
                                                  JOIN sales.order_items i
                                                  USING (order_id)
                                                  JOIN sales.products p
                                                  USING (product_id)
                                                  WHERE o.customer_id = @customer_id
                                                  ORDER BY o.ordered_at DESC
                                                  LIMIT @limit OFFSET @offset";
    public readonly record struct GetCustomerOrdersRow(Guid OrderId, DateTime OrderedAt, string OrderState, decimal TotalAmount, Guid OrderItemId, int Quantity, decimal UnitPrice, int ProductId, string ProductName, string ProductCategory);
    public readonly record struct GetCustomerOrdersArgs(int CustomerId, int Offset, int Limit);
    public async Task<List<GetCustomerOrdersRow>> GetCustomerOrdersAsync(GetCustomerOrdersArgs args)
    {
        if (this.Transaction == null)
        {
            var connection = GetDataSource();
            using (var command = connection.CreateCommand(GetCustomerOrdersSql))
            {
                command.Parameters.AddWithValue("@customer_id", args.CustomerId);
                command.Parameters.AddWithValue("@offset", args.Offset);
                command.Parameters.AddWithValue("@limit", args.Limit);
                using (var reader = await command.ExecuteReaderAsync())
                {
                    var result = new List<GetCustomerOrdersRow>();
                    while (await reader.ReadAsync())
                        result.Add(new GetCustomerOrdersRow { OrderId = reader.GetFieldValue<Guid>(0), OrderedAt = reader.GetDateTime(1), OrderState = reader.GetString(2), TotalAmount = reader.GetDecimal(3), OrderItemId = reader.GetFieldValue<Guid>(4), Quantity = reader.GetInt32(5), UnitPrice = reader.GetDecimal(6), ProductId = reader.GetInt32(7), ProductName = reader.GetString(8), ProductCategory = reader.GetString(9) });
                    return result;
                }
            }
        }

        if (this.Transaction?.Connection == null || this.Transaction?.Connection.State != ConnectionState.Open)
            throw new InvalidOperationException("Transaction is provided, but its connection is null.");
        using (var command = this.Transaction.Connection.CreateCommand())
        {
            command.CommandText = GetCustomerOrdersSql;
            command.Transaction = this.Transaction;
            command.Parameters.AddWithValue("@customer_id", args.CustomerId);
            command.Parameters.AddWithValue("@offset", args.Offset);
            command.Parameters.AddWithValue("@limit", args.Limit);
            using (var reader = await command.ExecuteReaderAsync())
            {
                var result = new List<GetCustomerOrdersRow>();
                while (await reader.ReadAsync())
                    result.Add(new GetCustomerOrdersRow { OrderId = reader.GetFieldValue<Guid>(0), OrderedAt = reader.GetDateTime(1), OrderState = reader.GetString(2), TotalAmount = reader.GetDecimal(3), OrderItemId = reader.GetFieldValue<Guid>(4), Quantity = reader.GetInt32(5), UnitPrice = reader.GetDecimal(6), ProductId = reader.GetInt32(7), ProductName = reader.GetString(8), ProductCategory = reader.GetString(9) });
                return result;
            }
        }
    }

    private const string AddProductsSql = "COPY sales.products (name, category, unit_price, stock_quantity, description) FROM STDIN (FORMAT BINARY)";
    public readonly record struct AddProductsArgs(string Name, string Category, decimal UnitPrice, int StockQuantity, string? Description);
    public async Task AddProductsAsync(List<AddProductsArgs> args)
    {
        using (var connection = new NpgsqlConnection(ConnectionString))
        {
            await connection.OpenAsync();
            using (var writer = await connection.BeginBinaryImportAsync(AddProductsSql))
            {
                foreach (var row in args)
                {
                    await writer.StartRowAsync();
                    await writer.WriteAsync(row.Name);
                    await writer.WriteAsync(row.Category);
                    await writer.WriteAsync(row.UnitPrice);
                    await writer.WriteAsync(row.StockQuantity);
                    await writer.WriteAsync(row.Description ?? (object)DBNull.Value);
                }

                await writer.CompleteAsync();
            }

            await connection.CloseAsync();
        }
    }

    private const string AddOrdersSql = "COPY sales.orders (customer_id, order_state, total_amount) FROM STDIN (FORMAT BINARY)";
    public readonly record struct AddOrdersArgs(int CustomerId, string OrderState, decimal TotalAmount);
    public async Task AddOrdersAsync(List<AddOrdersArgs> args)
    {
        using (var connection = new NpgsqlConnection(ConnectionString))
        {
            await connection.OpenAsync();
            using (var writer = await connection.BeginBinaryImportAsync(AddOrdersSql))
            {
                foreach (var row in args)
                {
                    await writer.StartRowAsync();
                    await writer.WriteAsync(row.CustomerId);
                    await writer.WriteAsync(row.OrderState);
                    await writer.WriteAsync(row.TotalAmount);
                }

                await writer.CompleteAsync();
            }

            await connection.CloseAsync();
        }
    }

    private const string AddOrderItemsSql = "COPY sales.order_items (order_id, product_id, quantity, unit_price) FROM STDIN (FORMAT BINARY)";
    public readonly record struct AddOrderItemsArgs(Guid OrderId, int ProductId, int Quantity, decimal UnitPrice);
    public async Task AddOrderItemsAsync(List<AddOrderItemsArgs> args)
    {
        using (var connection = new NpgsqlConnection(ConnectionString))
        {
            await connection.OpenAsync();
            using (var writer = await connection.BeginBinaryImportAsync(AddOrderItemsSql))
            {
                foreach (var row in args)
                {
                    await writer.StartRowAsync();
                    await writer.WriteAsync(row.OrderId);
                    await writer.WriteAsync(row.ProductId);
                    await writer.WriteAsync(row.Quantity);
                    await writer.WriteAsync(row.UnitPrice);
                }

                await writer.CompleteAsync();
            }

            await connection.CloseAsync();
        }
    }
}